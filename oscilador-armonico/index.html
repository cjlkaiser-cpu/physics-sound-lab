<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="description" content="Metr√≥nomo basado en oscilador arm√≥nico simple - Sistema masa-resorte">
    <title>Oscilador Arm√≥nico - Metr√≥nomo F√≠sico</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&family=Inter:wght@300;400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }

        body {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            background: #0a0a0a;
            font-family: 'Inter', sans-serif;
            color: #fff;
        }

        .app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: -webkit-fill-available;
        }

        .header {
            padding: 12px 20px;
            text-align: center;
            background: linear-gradient(180deg, #1a1a1a 0%, transparent 100%);
        }

        .header h1 {
            font-family: 'Inter', sans-serif;
            font-size: 1.4rem;
            font-weight: 600;
            color: rgba(255,255,255,0.95);
            letter-spacing: -0.02em;
        }

        .header .subtitle {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            min-height: 250px;
        }

        #canvas {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
            background: #1a1a1a;
            touch-action: none;
        }

        .controls {
            padding: 12px 16px 20px;
            background: linear-gradient(180deg, transparent 0%, #1a1a1a 30%);
            overflow-y: auto;
            max-height: 55vh;
        }

        .slider-group {
            margin-bottom: 12px;
        }

        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .slider-label {
            font-size: 0.75rem;
            color: #888;
        }

        .slider-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            color: #fbbf24;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #fbbf24;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        button {
            flex: 1;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active {
            transform: scale(0.96);
        }

        .btn-play { background: #4ade80; color: #000; }
        .btn-stop { background: #f87171; color: #000; }

        .toggles {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            min-width: 120px;
        }

        .toggle input { display: none; }

        .toggle-switch {
            width: 36px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            position: relative;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s;
        }

        .toggle input:checked + .toggle-switch {
            background: #4ade80;
        }

        .toggle input:checked + .toggle-switch::after {
            transform: translateX(16px);
        }

        .toggle-label {
            font-size: 0.75rem;
            color: #aaa;
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .info-item {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
        }

        .info-item .label {
            font-size: 0.65rem;
            color: #666;
            margin-bottom: 2px;
        }

        .info-item .value {
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: #fff;
        }

        .energy-section {
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 0.7rem;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .energy-bar {
            margin-bottom: 6px;
        }

        .energy-bar .bar-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            margin-bottom: 3px;
        }

        .energy-bar .bar-header .name { color: #888; }
        .energy-bar .bar-header .val {
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            color: #fff;
        }

        .energy-bar .bar-track {
            height: 5px;
            background: #222;
            border-radius: 2.5px;
            overflow: hidden;
        }

        .energy-bar .bar-fill {
            height: 100%;
            border-radius: 2.5px;
            transition: width 0.05s;
        }

        .bar-fill.ke { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
        .bar-fill.pe { background: linear-gradient(90deg, #60a5fa, #3b82f6); }
        .bar-fill.total { background: linear-gradient(90deg, #4ade80, #22c55e); }

        .equations {
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            padding: 10px;
        }

        .equation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .equation-row:last-child { border-bottom: none; }

        .equation-name {
            font-size: 0.65rem;
            color: #666;
        }

        .equation-text {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
            letter-spacing: 0.5px;
        }

        .equation-value {
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            font-weight: 500;
            color: #fbbf24;
        }

        @media (min-width: 768px) {
            .app {
                flex-direction: row;
                padding: 20px;
                gap: 25px;
                justify-content: center;
                align-items: flex-start;
            }

            .header { display: none; }

            .canvas-container { padding: 0; }

            #canvas {
                width: 500px;
                height: 350px;
            }

            .controls {
                width: 380px;
                padding: 20px;
                background: #1a1a1a;
                border-radius: 12px;
                max-height: 90vh;
            }

            .controls::before {
                content: 'Oscilador Arm√≥nico';
                display: block;
                font-family: 'Inter', sans-serif;
                font-size: 1.4rem;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .controls::after {
                content: 'Sistema Masa-Resorte';
                display: block;
                font-size: 0.7rem;
                color: #666;
                margin-bottom: 15px;
                padding-bottom: 12px;
                border-bottom: 1px solid #333;
            }

            .info-panel {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-height: 700px) {
            .controls { max-height: 50vh; }
            .equations { display: none; }
        }
    </style>
</head>
<body>
    <div class="app">
        <header class="header">
            <h1>Oscilador Arm√≥nico</h1>
            <div class="subtitle">Sistema Masa-Resorte</div>
        </header>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
        </div>

        <div class="controls">
            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Masa (m)</span>
                    <span class="slider-value" id="massDisplay">1.0 kg</span>
                </div>
                <input type="range" id="massSlider" min="0.1" max="5" step="0.1" value="1">
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Constante del resorte (k)</span>
                    <span class="slider-value" id="kDisplay">10.0 N/m</span>
                </div>
                <input type="range" id="kSlider" min="1" max="50" step="0.5" value="10">
            </div>

            <div class="slider-group">
                <div class="slider-header">
                    <span class="slider-label">Amplitud inicial (A)</span>
                    <span class="slider-value" id="ampDisplay">1.0 m</span>
                </div>
                <input type="range" id="ampSlider" min="0.2" max="2" step="0.1" value="1">
            </div>

            <div class="buttons">
                <button class="btn-play" id="playBtn">‚ñ∂ Iniciar</button>
                <button class="btn-stop" id="stopBtn">‚èπ Detener</button>
            </div>

            <div class="toggles">
                <label class="toggle">
                    <input type="checkbox" id="soundToggle" checked>
                    <span class="toggle-switch"></span>
                    <span class="toggle-label">üîä Sonido</span>
                </label>
                <label class="toggle">
                    <input type="checkbox" id="trailToggle" checked>
                    <span class="toggle-switch"></span>
                    <span class="toggle-label">üìà Gr√°fico x(t)</span>
                </label>
            </div>

            <div class="info-panel">
                <div class="info-item">
                    <div class="label">Posici√≥n x</div>
                    <div class="value" id="posVal">1.00 m</div>
                </div>
                <div class="info-item">
                    <div class="label">Velocidad v</div>
                    <div class="value" id="velVal">0.00 m/s</div>
                </div>
                <div class="info-item">
                    <div class="label">Per√≠odo T</div>
                    <div class="value" id="periodVal">1.99 s</div>
                </div>
                <div class="info-item">
                    <div class="label">Frecuencia œâ</div>
                    <div class="value" id="omegaVal">3.16 rad/s</div>
                </div>
                <div class="info-item">
                    <div class="label">BPM</div>
                    <div class="value" id="bpmVal">60</div>
                </div>
                <div class="info-item">
                    <div class="label">Beats</div>
                    <div class="value" id="beatCount">0</div>
                </div>
            </div>

            <div class="energy-section">
                <div class="section-title">Energ√≠as</div>
                <div class="energy-bar">
                    <div class="bar-header">
                        <span class="name">T = ¬Ωmv¬≤ (cin√©tica)</span>
                        <span class="val" id="keVal">0.00 J</span>
                    </div>
                    <div class="bar-track">
                        <div class="bar-fill ke" id="keBar"></div>
                    </div>
                </div>
                <div class="energy-bar">
                    <div class="bar-header">
                        <span class="name">U = ¬Ωkx¬≤ (potencial)</span>
                        <span class="val" id="peVal">5.00 J</span>
                    </div>
                    <div class="bar-track">
                        <div class="bar-fill pe" id="peBar"></div>
                    </div>
                </div>
                <div class="energy-bar">
                    <div class="bar-header">
                        <span class="name">E = T + U (total)</span>
                        <span class="val" id="totalVal">5.00 J</span>
                    </div>
                    <div class="bar-track">
                        <div class="bar-fill total" id="totalBar"></div>
                    </div>
                </div>
            </div>

            <div class="equations">
                <div class="section-title">Formulaci√≥n Newtoniana</div>
                <div class="equation-row">
                    <span class="equation-name">2¬™ Ley de Newton</span>
                    <span class="equation-text">F = ma = m·∫ç</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Ley de Hooke</span>
                    <span class="equation-text">F = ‚àíkx</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Ec. de Movimiento</span>
                    <span class="equation-text">m·∫ç = ‚àíkx  ‚Üí  ·∫ç + (k/m)x = 0</span>
                </div>
            </div>

            <div class="equations" style="margin-top: 10px;">
                <div class="section-title">Formulaci√≥n Lagrangiana</div>
                <div class="equation-row">
                    <span class="equation-name">Energ√≠a Cin√©tica</span>
                    <span class="equation-text">T = ¬Ωm·∫ã¬≤</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Energ√≠a Potencial</span>
                    <span class="equation-text">U = ¬Ωkx¬≤</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Lagrangiano</span>
                    <span class="equation-text">L = T ‚àí U = ¬Ωm·∫ã¬≤ ‚àí ¬Ωkx¬≤</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Euler-Lagrange</span>
                    <span class="equation-text">d/dt(‚àÇL/‚àÇ·∫ã) ‚àí ‚àÇL/‚àÇx = 0</span>
                </div>
            </div>

            <div class="equations" style="margin-top: 10px;">
                <div class="section-title">Soluci√≥n</div>
                <div class="equation-row">
                    <span class="equation-name">Frecuencia angular</span>
                    <span class="equation-text">œâ = ‚àö(k/m)</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Per√≠odo</span>
                    <span class="equation-text">T = 2œÄ‚àö(m/k)</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Posici√≥n</span>
                    <span class="equation-text">x(t) = A¬∑cos(œât)</span>
                </div>
                <div class="equation-row">
                    <span class="equation-name">Conservaci√≥n</span>
                    <span class="equation-text">E = T + U = ¬ΩkA¬≤ = cte</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let canvasW, canvasH;

        function setupCanvas() {
            const container = canvas.parentElement;
            const w = Math.min(container.clientWidth - 16, 600);
            const h = Math.min(container.clientHeight - 16, 350);

            const dpr = window.devicePixelRatio || 1;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            canvas.style.width = w + 'px';
            canvas.style.height = h + 'px';
            ctx.scale(dpr, dpr);

            canvasW = w;
            canvasH = h;
        }

        setupCanvas();
        window.addEventListener('resize', () => {
            setupCanvas();
            if (!running) draw();
        });

        // Physics
        let m = 1.0;      // mass (kg)
        let k = 10.0;     // spring constant (N/m)
        let A = 1.0;      // amplitude (m)
        let x = A;        // position
        let v = 0;        // velocity
        let running = false;
        let lastTime = 0;
        let prevX = 0;
        let soundEnabled = true;
        let showTrail = true;
        let beats = 0;
        let trail = [];
        let maxEnergy = 1;

        // Audio
        let audioCtx = null;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playClick() {
            if (!audioCtx || !soundEnabled) return;

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.02);

            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            osc.start(audioCtx.currentTime);
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function getOmega() {
            return Math.sqrt(k / m);
        }

        function getPeriod() {
            return 2 * Math.PI / getOmega();
        }

        function updateDisplay() {
            const omega = getOmega();
            const T = getPeriod();
            const bpm = Math.round(60 / (T / 2));  // 2 beats per period

            document.getElementById('massDisplay').textContent = m.toFixed(1) + ' kg';
            document.getElementById('kDisplay').textContent = k.toFixed(1) + ' N/m';
            document.getElementById('ampDisplay').textContent = A.toFixed(1) + ' m';

            document.getElementById('posVal').textContent = x.toFixed(2) + ' m';
            document.getElementById('velVal').textContent = v.toFixed(2) + ' m/s';
            document.getElementById('periodVal').textContent = T.toFixed(2) + ' s';
            document.getElementById('omegaVal').textContent = omega.toFixed(2) + ' rad/s';
            document.getElementById('bpmVal').textContent = bpm;
            document.getElementById('beatCount').textContent = beats;

            // Energies
            const KE = 0.5 * m * v * v;
            const PE = 0.5 * k * x * x;
            const total = KE + PE;

            if (total > maxEnergy) maxEnergy = total;
            const ref = maxEnergy > 0 ? maxEnergy : 1;

            document.getElementById('keVal').textContent = KE.toFixed(2) + ' J';
            document.getElementById('peVal').textContent = PE.toFixed(2) + ' J';
            document.getElementById('totalVal').textContent = total.toFixed(2) + ' J';
            document.getElementById('keBar').style.width = (KE / ref * 100) + '%';
            document.getElementById('peBar').style.width = (PE / ref * 100) + '%';
            document.getElementById('totalBar').style.width = (total / ref * 100) + '%';
        }

        function simulate(currentTime) {
            if (!running) return;

            const dt = Math.min((currentTime - lastTime) / 1000, 0.05);
            lastTime = currentTime;

            // Simple harmonic motion: ·∫ç = -(k/m)x
            // Using Euler method (sufficient for SHM)
            const omega2 = k / m;
            const a = -omega2 * x;
            v += a * dt;
            x += v * dt;

            // Beat detection: zero crossing
            if ((prevX > 0 && x <= 0) || (prevX < 0 && x >= 0)) {
                playClick();
                beats++;
            }
            prevX = x;

            // Trail for graph
            if (showTrail) {
                trail.push({ t: currentTime, x: x });
                // Keep last 3 seconds
                const cutoff = currentTime - 3000;
                while (trail.length > 0 && trail[0].t < cutoff) {
                    trail.shift();
                }
            }

            draw();
            updateDisplay();
            requestAnimationFrame(simulate);
        }

        function draw() {
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, canvasW, canvasH);

            const springY = canvasH * 0.35;
            const wallX = 40;
            const equilibriumX = canvasW * 0.45;
            const scale = 80;  // pixels per meter

            // Draw equilibrium line
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(equilibriumX, springY - 40);
            ctx.lineTo(equilibriumX, springY + 40);
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();
            ctx.setLineDash([]);

            // Label
            ctx.font = "12px 'Covered By Your Grace'";
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.fillText('x=0', equilibriumX - 10, springY + 55);

            // Mass position
            const massX = equilibriumX + x * scale;
            const massW = 50;
            const massH = 40;

            // Wall
            ctx.fillStyle = '#444';
            ctx.fillRect(wallX - 10, springY - 50, 10, 100);
            // Hatching
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(wallX - 10, springY - 50 + i * 10);
                ctx.lineTo(wallX, springY - 40 + i * 10);
                ctx.stroke();
            }

            // Spring
            const springStartX = wallX;
            const springEndX = massX - massW / 2;
            const coils = 12;
            const coilHeight = 15;
            const springLength = springEndX - springStartX;

            ctx.beginPath();
            ctx.moveTo(springStartX, springY);

            for (let i = 0; i <= coils; i++) {
                const px = springStartX + (springLength * i) / coils;
                const py = springY + (i % 2 === 0 ? -coilHeight : coilHeight) * (i > 0 && i < coils ? 1 : 0);
                ctx.lineTo(px, py);
            }

            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Mass (block)
            const gradient = ctx.createLinearGradient(massX - massW/2, springY - massH/2, massX + massW/2, springY + massH/2);
            gradient.addColorStop(0, '#fbbf24');
            gradient.addColorStop(0.5, '#f59e0b');
            gradient.addColorStop(1, '#d97706');

            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.roundRect(massX - massW/2, springY - massH/2, massW, massH, 6);
            ctx.fill();

            // Mass label
            ctx.fillStyle = '#000';
            ctx.font = "bold 14px Inter";
            ctx.textAlign = 'center';
            ctx.fillText('m', massX, springY + 5);
            ctx.textAlign = 'left';

            // Velocity arrow
            if (Math.abs(v) > 0.1) {
                const arrowLen = v * 15;
                const arrowY = springY;
                const arrowStartX = massX + massW/2 + 5;

                ctx.beginPath();
                ctx.moveTo(arrowStartX, arrowY);
                ctx.lineTo(arrowStartX + arrowLen, arrowY);
                ctx.strokeStyle = '#4ade80';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Arrowhead
                const dir = arrowLen > 0 ? 1 : -1;
                ctx.beginPath();
                ctx.moveTo(arrowStartX + arrowLen, arrowY);
                ctx.lineTo(arrowStartX + arrowLen - 8 * dir, arrowY - 5);
                ctx.moveTo(arrowStartX + arrowLen, arrowY);
                ctx.lineTo(arrowStartX + arrowLen - 8 * dir, arrowY + 5);
                ctx.stroke();

                ctx.fillStyle = '#4ade80';
                ctx.font = "bold 11px Inter";
                ctx.fillText('v‚Éó', arrowStartX + arrowLen/2 - 5, arrowY - 10);
            }

            // Force arrow (F = -kx)
            const F = -k * x;
            if (Math.abs(F) > 0.5) {
                const forceScale = 0.8;
                const forceLen = F * forceScale;
                const forceY = springY + 30;
                const forceStartX = massX;

                ctx.beginPath();
                ctx.moveTo(forceStartX, forceY);
                ctx.lineTo(forceStartX + forceLen, forceY);
                ctx.strokeStyle = '#f87171';
                ctx.lineWidth = 2;
                ctx.stroke();

                const dir = forceLen > 0 ? 1 : -1;
                ctx.beginPath();
                ctx.moveTo(forceStartX + forceLen, forceY);
                ctx.lineTo(forceStartX + forceLen - 6 * dir, forceY - 4);
                ctx.moveTo(forceStartX + forceLen, forceY);
                ctx.lineTo(forceStartX + forceLen - 6 * dir, forceY + 4);
                ctx.stroke();

                ctx.fillStyle = '#f87171';
                ctx.font = "bold 10px Inter";
                ctx.fillText('F=-kx', forceStartX + forceLen/2 - 15, forceY + 15);
            }

            // Graph x(t) at bottom
            if (showTrail && trail.length > 1) {
                const graphY = canvasH * 0.75;
                const graphH = canvasH * 0.2;
                const graphW = canvasW - 80;
                const graphX = 40;

                // Axes
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(graphX, graphY);
                ctx.lineTo(graphX + graphW, graphY);
                ctx.moveTo(graphX, graphY - graphH/2);
                ctx.lineTo(graphX, graphY + graphH/2);
                ctx.stroke();

                // Labels
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = "10px Inter";
                ctx.fillText('x(t)', graphX + 5, graphY - graphH/2 + 12);
                ctx.fillText('t', graphX + graphW - 10, graphY - 8);

                // Plot
                ctx.beginPath();
                const now = trail[trail.length - 1].t;
                const timeWindow = 3000;

                for (let i = 0; i < trail.length; i++) {
                    const pt = trail[i];
                    const tNorm = (pt.t - (now - timeWindow)) / timeWindow;
                    const px = graphX + tNorm * graphW;
                    const py = graphY - (pt.x / A) * (graphH / 2) * 0.8;

                    if (i === 0) ctx.moveTo(px, py);
                    else ctx.lineTo(px, py);
                }

                ctx.strokeStyle = '#fbbf24';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Current point
                const currentPt = trail[trail.length - 1];
                const currentPx = graphX + graphW;
                const currentPy = graphY - (currentPt.x / A) * (graphH / 2) * 0.8;

                ctx.beginPath();
                ctx.arc(currentPx, currentPy, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#fbbf24';
                ctx.fill();
            }

            // Flash on beat (near equilibrium)
            if (running && Math.abs(x) < 0.1 * A) {
                ctx.fillStyle = gradient;
                ctx.shadowColor = '#fbbf24';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.roundRect(massX - massW/2, springY - massH/2, massW, massH, 6);
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Info on canvas
            ctx.font = "16px 'Covered By Your Grace'";
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            const bpm = Math.round(60 / (getPeriod() / 2));
            ctx.fillText(bpm + ' BPM', canvasW - 70, 25);
        }

        // Controls
        document.getElementById('massSlider').addEventListener('input', (e) => {
            m = parseFloat(e.target.value);
            maxEnergy = 1;
            updateDisplay();
            if (!running) draw();
        });

        document.getElementById('kSlider').addEventListener('input', (e) => {
            k = parseFloat(e.target.value);
            maxEnergy = 1;
            updateDisplay();
            if (!running) draw();
        });

        document.getElementById('ampSlider').addEventListener('input', (e) => {
            A = parseFloat(e.target.value);
            if (!running) {
                x = A;
                v = 0;
            }
            maxEnergy = 1;
            updateDisplay();
            if (!running) draw();
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (!running) {
                initAudio();
                running = true;
                x = A;
                v = 0;
                prevX = A;
                lastTime = performance.now();
                trail = [];
                beats = 0;
                requestAnimationFrame(simulate);
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            running = false;
            x = A;
            v = 0;
            trail = [];
            maxEnergy = 1;
            beats = 0;
            draw();
            updateDisplay();
        });

        document.getElementById('soundToggle').addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
            if (soundEnabled) initAudio();
        });

        document.getElementById('trailToggle').addEventListener('change', (e) => {
            showTrail = e.target.checked;
            if (!showTrail) trail = [];
            if (!running) draw();
        });

        // Touch to init audio (iOS)
        document.body.addEventListener('touchstart', () => {
            initAudio();
        }, { once: true });

        // Init
        updateDisplay();
        draw();
    </script>
</body>
</html>
